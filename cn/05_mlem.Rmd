# Mixed Linear Effects Models  {#asm-mlem}
```{r met-mlem-reset, include=FALSE}
met$set_this_rmd_file(ps_this_rmd_file = ifelse(rstudioapi::isAvailable(), 
                                                 rstudioapi::getSourceEditorContext()$path, 
                                                 rprojroot::thisfile()))
```

Mixed linear effects models are a very useful tool in the analysis of data with some dependencies. In all statistical analyses that we have seen so far the assumption of independence between observations was central. One way of expressing this independence assumption is via the variance-covariance matrix ($var(\mathbf{e})$) of the vector ($\mathbf{e}$) of residuals. In mathematical terms this can be written as 

\begin{equation}
var(\mathbf{e}) = \mathbf{I} * \sigma_e^2
(\#eq:varemlem)
\end{equation}

which means that the variance-covariance matrix ($var(\mathbf{e})$) is proportional to the identity matrix $\mathbf{I}$ with the variance component $\sigma_e^2$ as proportionality factor. 

In what follows, the models that account for different dependency structures are described. 


## Repeated Observations
It is quite common to have repeated observations of the same traits or characteristics from a group of animals. If we apply that line of thought to the example data used in chapter \@ref(asm-regr), we would have repeated measurements of breast circumference and body weight of the same animals. Such a dataset is shown in Table \@ref(tab:rep-obs-bw-bc-tab).

```{r rep-obs-bw-bc-tab, echo=FALSE}
s_rep_obs_path <- "https://charlotte-ngs.github.io/asmss2022/data/asm_bw_bc_rep_obs.csv"
tbl_rep_obs <- readr::read_csv(file = s_rep_obs_path)
knitr::kable(tbl_rep_obs,
             booktabs = TRUE,
             longtable = TRUE,
             caption = "Repeated Observations for Body Weight and Breast Circumference")
```

In Table \@ref(tab:rep-obs-bw-bc-tab), the column entitiled `Animal` is no longer a running counter which enumerates the observation records. In this repeated observation dataset, the column `Animal` denotes for which animal the measurements was observed. The association between observations and animals is shown in Figure \@ref(fig:rep-obs-bw-bc-fig). 

```{r rep-obs-bw-bc-fig, echo=FALSE, out.width="100%", fig.cap="Repeated Observations of Breast Circumference and Body Weight"}
tbl_rep_obs$Animal <- as.factor(tbl_rep_obs$Animal)
ggplot2::ggplot(data = tbl_rep_obs, 
                mapping = ggplot2::aes(x = `Breast Circumference`,
                                       y = `Body Weight`,
                                       color = Animal)) + 
  ggplot2::geom_point()
```

The color codes in Figure \@ref(fig:rep-obs-bw-bc-fig) identify the observations for the same animal. This shows that observations for the same animal tend to be grouped together. This grouping has to be considered in the staistical analysis of such a dataset.


### Statistical Analysis
In principle, the dataset shown in Table \@ref(tab:rep-obs-bw-bc-tab) can be analysed with a linear regression model. But from the plot (Figure \@ref(fig:rep-obs-bw-bc-res-plot)) of the residuals on the fitted values, it becomes clear that the assumptions of the residuals showning no covariance is violated. 

```{r rep-obs-bw-bc-res-plot, echo=FALSE, out.width="100%", fig.cap="Residuals vs. Fitted Values Plot for Linear Regression Model of Repeated Observation Data"}
lm_rep_obs <- lm(`Body Weight` ~ `Breast Circumference`, data = tbl_rep_obs)
tbl_rep_obs$Animal <- as.factor(tbl_rep_obs$Animal)
ggplot2::ggplot(data = tibble::tibble(Animal = tbl_rep_obs$Animal, 
                                      Fitted = fitted(lm_rep_obs), 
                                      Residuals = residuals(lm_rep_obs)),
                ggplot2::aes(x = Fitted, y = Residuals, color = Animal)) + 
  ggplot2::geom_point()
```



## Pedigree BLUP


## Genomic BLUP


## Other Resources
The following resources were used for this chapter:

* https://m-clark.github.io/mixed-models-with-R/
* https://www.r-bloggers.com/2017/12/linear-mixed-effect-models-in-r/
* https://gkhajduk.github.io/2017-03-09-mixed-models/
* `r met$add("Brown2021a")`
* `r met$add("Singmann2019")`

