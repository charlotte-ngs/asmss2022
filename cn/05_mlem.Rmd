# Mixed Linear Effects Models  {#asm-mlem}
```{r met-mlem-reset, include=FALSE}
met$set_this_rmd_file(ps_this_rmd_file = ifelse(rstudioapi::isAvailable(), 
                                                 rstudioapi::getSourceEditorContext()$path, 
                                                 whereami::thisfile()))
```

Mixed linear effects models are a very useful tool in the analysis of data with some dependencies. In all statistical analyses that we have seen so far the assumption of independence between observations was central. One way of expressing this independence assumption is via the variance-covariance matrix ($var(\mathbf{e})$) of the vector ($\mathbf{e}$) of residuals. In mathematical terms this can be written as 

\begin{equation}
var(\mathbf{e}) = \mathbf{I} * \sigma_e^2
(\#eq:varemlem)
\end{equation}

which means that the variance-covariance matrix ($var(\mathbf{e})$) is proportional to the identity matrix $\mathbf{I}$ with the variance component $\sigma_e^2$ as proportionality factor. 

In what follows, the models that account for different dependency structures are described. 


## Repeated Observations
It is quite common to have repeated observations of the same traits or characteristics from a group of animals. Observing the same characteristic of the same animal multiple times is expected to yield a more accurate description of any relationship between different traits such as body weight and breast circumference. If we apply that line of thought to the example data used in chapter \@ref(asm-regr), we would have repeated measurements of breast circumference and body weight of the same animals. Such a dataset is shown in Table \@ref(tab:rep-obs-bw-bc-tab) for a selected number of animals.

```{r rep-obs-bw-bc-tab, echo=FALSE}
s_rep_obs_path <- "https://charlotte-ngs.github.io/asmss2022/data/asm_bw_bc_rep_obs.csv"
tbl_rep_obs <- readr::read_csv(file = s_rep_obs_path)
knitr::kable(tbl_rep_obs,
             booktabs = TRUE,
             longtable = TRUE,
             caption = "Repeated Observations for Body Weight and Breast Circumference")
```

In Table \@ref(tab:rep-obs-bw-bc-tab), the column entitiled `Animal` is no longer a running counter which enumerates the observation records. In this repeated observation dataset, the column `Animal` denotes for which animal the measurements was observed. The association between observations and animals is shown in Figure \@ref(fig:rep-obs-bw-bc-fig). 

```{r rep-obs-bw-bc-fig, echo=FALSE, out.width="100%", fig.cap="Repeated Observations of Breast Circumference and Body Weight"}
tbl_rep_obs$Animal <- as.factor(tbl_rep_obs$Animal)
ggplot2::ggplot(data = tbl_rep_obs, 
                mapping = ggplot2::aes(x = `Breast Circumference`,
                                       y = `Body Weight`,
                                       color = Animal)) + 
  ggplot2::geom_point()
```

The color codes in Figure \@ref(fig:rep-obs-bw-bc-fig) identify the observations for the same animal. This shows that observations for the same animal tend to be grouped together. This grouping has to be considered in the staistical analysis of such a dataset.


### Statistical Analysis
In principle, the dataset shown in Table \@ref(tab:rep-obs-bw-bc-tab) can be analysed with a linear regression model. But from the plot (Figure \@ref(fig:rep-obs-bw-bc-res-plot)) of the residuals versus the fitted values, it becomes clear that the residuals are grouped according to the animals from which the measurement was taken. Due to the small size of the dataset, the grouping effect according to the animal does not show up as clearly as intended. But never the less, this grouping indicates that the assumption of independent residuals is violated.

```{r rep-obs-bw-bc-res-plot, echo=FALSE, out.width="100%", fig.cap="Residuals vs. Fitted Values Plot for Linear Regression Model of Repeated Observation Data"}
lm_rep_obs <- lm(`Body Weight` ~ `Breast Circumference`, data = tbl_rep_obs)
tbl_rep_obs$Animal <- as.factor(tbl_rep_obs$Animal)
ggplot2::ggplot(data = tibble::tibble(Animal = tbl_rep_obs$Animal, 
                                      Fitted = fitted(lm_rep_obs), 
                                      Residuals = residuals(lm_rep_obs)),
                ggplot2::aes(x = Fitted, y = Residuals, color = Animal)) + 
  ggplot2::geom_point()
```


### Analysis of Variance
Traditionally repeated measurement data have been analyzed using a statistical technique referred to as analysis of variance (ANOVA). ANOVA is a general method that has been used for a long time to assess the variability of different factors in a dataset. This is done by constructing a specific type of table (ANOVA-table) which presents the essential features of a given dataset (see `r met$add("Searle1992")` for more details). The structure and the properties of an ANOVA-table can best be demonstrated by an analysis of a dataset that shows the influence of the factor breed on body weight of animals shown in Table \@ref(tab:bw-breed-tab).

```{r bw-breed-tab, echo=FALSE}
s_rep_obs_path <- "https://charlotte-ngs.github.io/asmss2022/data/asm_bw_flem.csv"
tbl_bw_breed <- readr::read_csv(file = s_rep_obs_path)
tbl_bw_breed <- dplyr::select(tbl_bw_breed, Animal, `Body Weight`, Breed)
tbl_bw_breed$Breed <- as.factor(tbl_bw_breed$Breed)
knitr::kable(tbl_bw_breed,
             booktabs = TRUE,
             longtable = TRUE,
             caption = paste0("Body Weight and Breed for ", nrow(tbl_bw_breed), " Beef Animals", collapse = ""))
```

A one-factor analysis of variance of the data shown in Table \@ref(tab:bw-breed-tab) can answer the question, whether the factor `Breed` has an influence on the response variable `Body Weight`. An ANOVA in R can be constructed by the function `aov()` as follows.

```{r aov-bw-breed}
aov_bw_breed <- aov(`Body Weight` ~ Breed, data = tbl_bw_breed)
(smry_aov_bw_breed <- summary(aov_bw_breed))
```

The result of the one-way ANOVA of `Body Weight` ond `Breed` shows that it is very unlikely that `Breed` does not have any influence on `Body Weight`. The presented test-statistic from an F-Test is the same that is also shown by the summary results of a result from the `lm()` function. The ANOVA table which is presented by the `summary()` function applied to the `aov`-object contains also an estimate ($\widehat{\sigma_e^2})$ of the residual variance component ($\sigma_e^2$). The estimate corresponds to the mean sum of squares for the component `Residuals`. For our dataset the estimate is `r round(smry_aov_bw_breed[[1]]["Residuals", "Mean Sq"], digits=1)`. Taking the square root of this value results in the `Residual standard error` shown in the summary output of an `lm()`-analysis.

Extending the dataset shown in Table \@ref(tab:bw-breed-tab) to multiple observations for a selected number of animals results in the dataset given in Table \@ref(tab:bw-breed-rep-obs-tab).

```{r bw-breed-rep-obs-tab, echo=FALSE}
s_bw_breed_rep_obs_path <- "https://charlotte-ngs.github.io/asmss2022/data/asm_bw_breed_rep_obs.csv"
tbl_rep_obs_breed <- readr::read_csv(file = s_bw_breed_rep_obs_path)
tbl_rep_obs_breed <- dplyr::select(tbl_rep_obs_breed, Animal, `Body Weight`, Breed)
tbl_rep_obs_breed$Animal <- as.factor(tbl_rep_obs_breed$Animal)
knitr::kable(tbl_rep_obs_breed,
             booktabs = TRUE,
             longtable = TRUE,
             caption = "Repeated Observations of Body Weight and Breed for Beef Cattle Animals")
```

Applying an ANOVA on the dataset given in Table \@ref(tab:bw-breed-rep-obs-tab) allows to check whether there is variation between measurements of the same animal.

```{r}
aov_bw_breed_rep <- aov(`Body Weight` ~ Breed + Error(Animal), data = tbl_rep_obs_breed)
summary(aov_bw_breed_rep)
```

The above ANOVA results show that taking into account the repeated measurement structure of the data greatly reduces the mean squared residuals. On the other hand due to the low number of animals in the dataset, the null-hypothesis of the factor `Breed` having no effect on `Body Weight` could not be rejected. 

While ANOVA is a widely used method and the above results show that we were able to correctly separate the variation between breeds and within a series of observation for the same animal, it has a major disadvantage. ANOVA cannot handle so-called **unbalanced** data very well. Unbalanced data means that the number of observations per factor level or per animal is not the same. Because the problem of unbalanced data occurs quite frequently even in planned experiments, ANOVA is not used that often nowadays. The problems of unbalanced data can be addressed by a different class of models, called the mixed linear effects models.


### Random Effects Models
Before, we introduce the mixed linear effects model, we first have a look at how the repeated measurements data can be modelled with a random effects model. For the demonstration of the random effects model, we use the dataset in Table \@ref(tab:bw-breed-rep-obs-tab), but we are ignoring the factor `Breed` for a moment. Then this dataset just looks like a repeated measurement of the body weight of some beef cattle animals (see Table \@ref(tab:bw-rep-meas-tab)). 

```{r bw-rep-meas-tab, echo=FALSE}
tbl_rep_obs_no_breed <- dplyr::select(tbl_rep_obs_breed, Animal, `Body Weight`)
knitr::kable(tbl_rep_obs_no_breed,
             booktabs = TRUE,
             longtable = TRUE,
             caption = "Repeated Measurements of Body Weight for Beef Cattle Animals")
```

In a random effects model with repeated observations, the expected value $E(y_{ij})$ for body weight $y_{ij}$ of animal $i$ with the $j^{th}$ observation can be written as 

\begin{equation}
E(y_{ij}) = \mu + \alpha_i
(\#eq:repobsbwremmlem)
\end{equation}

Algebraically the expression for $E(y_{ij})$ given in \@ref(eq:repobsbwremmlem) is not different from what we have seen for the fixed linear effects model in chapter \@ref(asm-flem). But the assumptions are different. In \@ref(eq:repobsbwremmlem), $\alpha_i$ is the effect of animal $i$ on the observed body weight. Because the animals in the dataset (Table \@ref(tab:bw-rep-meas-tab)) is a random sample of a large population of animals, the effect $\alpha_i$ is a so-called **random effect**. A random effect in a model is to be treated as a random variable for which, we have to specify its distributional properties such as expected value and variance. For our example of the repeated measurements data, we assume the following three properties for the $\alpha_i$ effects

1. they are indepentently and identically distributed (i.i.d.)
2. they all have expected value of $0$, $E(\alpha_i) = 0 \quad \forall i$
3. they all have the same variance $\sigma_{\alpha}^2$, $var(\alpha_i) = E\left[\alpha_i - E(\alpha_i)\right]^2 = E(\alpha_i^2) = \sigma_{\alpha}^2$ with $cov(\alpha_i, \alpha_k)=0 \quad \forall i \ne k$

A further consequence of choosing $\alpha_i$ as a random effect is that, the expected value in \@ref(eq:repobsbwremmlem) must be considered a second time and must be specified with more details. Assuming that $\alpha^*$ denotes the general random animal effect on the observed body weight. For a given animal $i$, the effect is then $\alpha_i$ which is a realized but unobservable value of the distribution of the $\alpha^*$ effects. Therefore in \@ref(eq:repobsbwremmlem) the expected value of $y_{ij}$ is conditional on the fact that the random variable $\alpha^*$ takes the value $\alpha_i$. Hence \@ref(eq:repobsbwremmlem) is a conditional mean

\begin{equation}
E(y_{ij} | \alpha^* = \alpha_i) = \mu + \alpha_i
(\#eq:repobsbwcondexpmlem)
\end{equation}

For notational simplicity, the $\alpha^*$ is often ommitted. Taking expectation over $\alpha^*$ leads to 

\begin{equation}
E_{\alpha^*}\left[E(y_{ij} | \alpha_i) \right] = E(y_{ij}) = \mu
(\#eq:repobsbwcondexpalphamlem)
\end{equation}

The residuals are defined as 

\begin{equation}
e_{ij} = y_{ij} - E(y_{ij} | \alpha_i) = y_{ij} - (\mu + \alpha_i)
(\#eq:repobsbwresmlem)
\end{equation}

With that definition, we can establish the model equation for an observation $y_{ij}$ as

\begin{equation}
y_{ij} = \mu + \alpha_i + e_{ij}
(\#eq:repobsbwmodeleqmlem)
\end{equation}

The properties of the residuals are assumed analogously to the fixed effects model. In summary, the properties are listed as 

* the expected value of the residuals are all $0$, $E(e_{ij}) = 0$
* the variances of the residuals are all equal to $\sigma_e^2$, $var(e_{ij}) = E(e_{ij}^2) = \sigma_e^2$
* all residuals are independent, $cov(e_{ij}, e_{i'j'}) = 0 \quad \forall i,i' \text{ and } \forall j,j' \text{ except } i=i' \text{ and } j=j'$
* residuals are independen of $\alpha_i$ effects, $cov(e_{ij}, \alpha_k) = 0 \quad \forall i, j, k$

Together with \@ref(eq:repobsbwmodeleqmlem), we can establish the total variance of all observations $y_{ij}$ as

\begin{equation}
var(y_{ij}) = var(\mu + \alpha_i + e_{ij}) = \sigma_{\alpha}^2 + \sigma_e^2 = \sigma_y^2
(\#eq:repobsbwvarymlem)
\end{equation}

This shows that the variance ($\sigma_y^2$) can be decomposed into the two variance components $\sigma_{\alpha}^2$ and $\sigma_e^2$. It is also noted that the intra-class covariance which corresponds to the covariance between body weights for the same animal can be written as

\begin{equation}
cov(y_{ij}, y_{ij'}) = cov(\mu + \alpha_i + e_{ij}, \mu + \alpha_i + e_{ij'}) = \sigma_{\alpha}^2 \quad \text{ for } j \ne j'
(\#eq:repobsbwintraclasscovmlem)
\end{equation}

#### Package lme4
In R, one of the packages that can handle random effects models is the package `lme4`. For the dataset in Table \@ref(tab:bw-rep-meas-tab), this can be done as follows

```{r lme-rep-meas-analysis}
library(lme4)
lmer_bw_rep <- lmer(`Body Weight` ~ (1 | Animal), data = tbl_rep_obs_no_breed)
summary(lmer_bw_rep)
```


###  Linear Mixed Effects Models
Linear mixed effects models or just _mixed models_ are a combination or a merger of fixed linear effects models and random models. That means mixed models contain both fixed effects and random effects. A first example of a dataset which can be modelled with a mixed model is shown in Table \@ref(tab:bw-breed-rep-obs-tab). In this dataset, the factor `Breed` is regarded as a fixed effect whereas the influence of the animal on a single measurement is considered as a random effect. Hence, body weight $y_{ijk}$ which corresponds to repeated observation $k$ of animal $j$ from breed $i$ can be written as

\begin{equation}
y_{ijk} = b_0 + b_i + \alpha_j + e_{ijk}
(\#eq:singleobsmlem)
\end{equation}

where $b_0$ is the intercept, $b_i$ is the fixed effect of breed $i$, $\alpha_j$ is the random effect of animal $j$ and $e_{ijk}$ is the random residual. In matrix-vector notation equation \@ref(eq:singleobsmlem) takes the form 

\begin{equation}
\mathbf{y} = \mathbf{Xb} + \mathbf{Z}\alpha + \mathbf{e}
(\#eq:matvecnotmlem)
\end{equation}

where $\mathbf{y}$ is the vector of length $n$ containing responses, $\mathbf{b}$ the vector of length $p$ with covariates, $\alpha$ the vector of length $q$ with random effects related to the repeated observations for an animal and $\mathbf{e}$ is the vector of length $n$ with random residuals. The matrices $\mathbf{X}$ and $\mathbf{Z}$ relate the different effects to the observations. 

From equation \@ref(eq:singleobsmlem), we cannot really tell any difference to a fixed linear effects model. Only with the specification of the distributional properties of all the model components, it becomes clear that equation  \@ref(eq:singleobsmlem) specifies a mixed model. The mixed model is characterized by two random variables

1. a $q$-dimensional vector of random effects represented by the random variable $\alpha^*$
2. a $n$-dimensional vector of responses represented by the random variable $\mathbf{\mathcal{Y}}^*$

The datasets to be analysed with mixed models contain observations, denoted by the vector $\mathbf{y}$. Values $\alpha$ of $\alpha^*$ are not observed and hence are unknown. When specifying the distributional properties of a mixed model, the unconditional distribution of $\alpha^*$ and the conditional distribution of $(\mathbf{\mathcal{Y}}^*|\alpha^*)$ are given. The description of these distributions involve the form of the distribution and the values of the distributional parameters. The observations of the responses and of the covariates are used to estimate these parameters. The unconditional distribution of $\alpha^*$ and the conditional distribution of $(\mathbf{\mathcal{Y}}^*|\alpha^*)$ are both assumed to be multivariate normal distributions. 

\begin{align}
(\mathbf{\mathcal{Y}}^*|\alpha^*) & \sim \mathcal{N}(\mathbf{Xb} + \mathbf{Z}\alpha, \sigma^2 * I) \notag \\
\alpha^* & \sim  \mathcal{N}(\mathbf{0},\Sigma)
(\#eq:distalphaygivenalphamlem)
\end{align}

The analysis of the dataset shown in Table \@ref(tab:bw-breed-rep-obs-tab) can be analysed using the function `lmer()` of package `lme4`. 

```{r}
mlem__rep_obs_breed <- lme4::lmer(`Body Weight` ~ Breed + (1|Animal), 
                                  data = tbl_rep_obs_breed)
summary(mlem__rep_obs_breed)
```

The variance components obtained by `lme4::lmer()` are the same as what we have seen before as results of ANOVA. This is because, we are looking at balanced data. 

In livestock breeding, linear mixed effects models are of interest when it comes to the evaluation of the genetic potential of selection candidates. From quantitative genetics, we know that parents with a superior genetic potential produce offspring which are better on average compared to the mean performance of animals from the same generation. The genetic potential of an animal is quantified by a concept which is referred to as _breeding value_. In what follows, we describe how breeding values for animals can be predicted using mixed models. 


## Sire Model
In a first application of mixed models for predicting breeding values, observation of daughter performance records were used to predict breeding values for sires. Assuming that sires are unrelated, i.e. they do not share any common ancestors, sire breeding values can be predicted similarly to the analysis of the repeated observations dataset. A possible mixed model for such an analysis might look as follows

\begin{equation}
\mathbf{y} = \mathbf{Xb} + \mathbf{Zs} + \mathbf{e}
(\#eq:sireunrelatedmlem)
\end{equation}

where $\mathbf{y}$ is the vector of length $n$ with responses, $\mathbf{b}$ is the vector of length $p$ with fixed effects, $\mathbf{s}$ is the vector of length $q$ with sire breeding values and $\mathbf{e}$ is the vector of length $n$ with random residuals. Matrices $\mathbf{X}$ and $\mathbf{Z}$ are design matrices which relate the observations to the respective effects.

A dataset that can be used to be analysed with a model such as shown in equation \@ref(eq:sireunrelatedmlem) is given in by the `milk` dataset of the package `pedigreemm`. The first six lines of this dataset are shown in Table \@ref(tab:milkdatapedigreemmtabmlem). 

```{r milkdatapedigreemmtabmlem, echo=FALSE}
tbl_milk_pedigreemm_head <- tibble::as.tibble(head(pedigreemm::milk))
knitr::kable(tbl_milk_pedigreemm_head,
             booktabs = TRUE,
             longtable = TRUE,
             caption = "First six lines of milk dataset from package pedigreemm")
```

In Table \@ref(tab:milkdatapedigreemmtabmlem) the columns `milk`, `fat`, `prot` and `scs` stand for milk yield, fat yield, protein yield and somatic cell score for a given lactation of a cow, respectively and can be selected as response variables. The columns `lact`, `herd` and `dim` are lactation, herd number and days in milk, respectively and these columns can be used as fixed effects or covariates. The sire column is used for the random sire breeding value effect in the model. 

As already stated, if we assume that these sires are unrelated, the dataset can be analysed as shown above using the function `lme4::lmer`. 


## Pedigree BLUP
In real datasets, the assumption of unrelated sires is unrealistic, because the selection process favors that male offspring of a given sire will be selected as sires again. As a consequence, the random sire effects are not independent. The dependence structure between the sire effects must be considered in the analysis. The sire model can still be written as shown in equation \@ref(eq:sireunrelatedmlem), but the variance-covariance matrix of the random sire effects ($\mathbf{s}$) is no longer an identity matrix $\mathbf{I}$ times a common variance component $\sigma_s^2$, but it can be written as 

\begin{equation}
var(\mathbf{s}) = \mathbf{A}_s * \sigma_s^2
(\#eq:sirevarcovmlem)
\end{equation}

where $\mathbf{A}_s$ is the sire relationship matrix. In a dataset with $q$ sires, the matrix $\mathbf{A}_s$ has dimensions $q\times q$ and it contains the proportions of sire effects that are passed from father to son. Together with the sire variance $\sigma_s^2$ this defines the variance-covariance structure of all sire effects. As an example, we can express the covariance $cov(s_i, s_k)$ of the sire effects between son $i$ and its sire $k$, as

\begin{equation}
cov(s_i, s_k) = 1/2 * \sigma_s^2
(\#eq:sirevarcovmlem)
\end{equation}

where the factor $1/2$ stems from the fact that sire $k$ passes half of its genetic potential to its son $i$. Relating this single covariance back to the variance-covariance matrix $A_s$ means that elements $(i,k)$ and $(k,i)$ are both $1/2$. 


### Example Dataset
An application of the sire model is shown in the dataset given in Table \@ref(tab:siremodeldatamlem) which is taken from `r met$add("Mrode2005")`

```{r siremodeldatamlem, echo=FALSE}
sigma_s2 <- 5
sigma_e2 <- 55
sigma_p2 <- sigma_s2 + sigma_e2
tbl_sire_model <- tibble::tibble(Animal = c(4:8),
                                 Sire   = c(1,3,1,4,3),
                                 Sex    = c("M","F","F","M","M"),
                                 WWG    = c(4.5, 2.9, 3.9, 3.5, 5.0))
knitr::kable(tbl_sire_model,
             booktabs = TRUE,
             longtable = TRUE,
             caption = "Pre-weaning Gain in kg for five beef animals")
```

The objective is to predict breeding values for sires $1$, $3$ and $4$ based on the above dataset. The trait pre-weaning gain (`WWG`) is taken as response and `Sex` is assumed to be the only fixed effect. The following values for the variance components are assumed: $\sigma_s^2 = `r sigma_s2`$ and $\sigma_e^2 = `r sigma_e2`$. 

This type of model where the structure of the variance-covariance matrix of the random effect is given by a pedigree cannot be fit by the package `lme4`. An extension of `lme4` is given in the R-package `pedigreemm`. In `pedigreemm` it is possible to specify the variance-covariance structure via a pedigree. For our example of the dataset in Table \@ref(tab:siremodeldatamlem), this can be done as follows

```{r}
library(pedigreemm)
ped_sire <- pedigree(sire = c(rep(NA,2), 1), dam = rep(NA,3), 
                     label = as.character(c(1,3,4)))
lmem_sire <- pedigreemm(
  formula = WWG ~ Sex + (1 | Sire), 
  data = tbl_sire_model,
  pedigree = list(Sire = ped_sire)
)
(smry_lmem_sire <- summary(lmem_sire))
```

The output of `pedigreemm::pedigreemm()` is equivalent to the one given by `lme4::lmer()`. From this we can see that the sire variance results in an estimate of `r attr(smry_lmem_sire$varcor[[1]], "stddev")[[1]]`. This does not correspond to the value that, we specified as an assumption. This has two reasons. The assumed sire variance was not estimated from the small dataset in Table \@ref(tab:siremodeldatamlem), but from a larger dataset not shown here. The second reason is that it is not possible with `pedigreemm::pedigreemm()` to use an assumed variance component as input. The breeding values for the sires can be obtained by the function call

```{r}
ranef(lmem_sire)
```

The predicted sire breeding values are also all equal to $0$. The reason for this is that the sire variance component was estimated to be $0$. Hence for small datasets, `pedigreemm::pedigreemm()` cannot be used. 


### Mixed Model Equations
In a series of papers (`r met$add("Henderson1953")`, `r met$add("Henderson1963")` and `r met$add("Henderson1975")`) which are summarized in `r met$add("Henderson1982")`, a technique called __mixed model equations__ was developed to solve for solutions of predicted values in a linear mixed effects model. For a given linear mixed effects model with $var(e) = I*\sigma_e^2$ and $var(s) = A_s * \sigma_s^2$ 

\begin{equation}
\mathbf{y} = \mathbf{Xb} + \mathbf{Zs} + \mathbf{e}
(\#eq:sireunrelatedtwomlem)
\end{equation}

the solutions for the fixed effects estimates and the predicted values of the random effects can be obtained by solving the following set of equations. 

\begin{equation}
\left[ 
\begin{array}{cc}
X^TX  &  X^TZ \\
Z^TX  &  Z^TZ + \lambda A_s^{-1}
\end{array}
\right]
\left[ 
\begin{array}{c}
\hat{b} \\
\hat{s}
\end{array}
\right]
= 
\left[ 
\begin{array}{c}
X^Ty \\
Z^Ty
\end{array}
\right]
(\#eq:siremmemlem)
\end{equation}

where $\lambda = \sigma_e^2 / \sigma_s^2$. For our example the matrices $X$ and $Z$ are defined as

```{r, echo=FALSE, results='asis'}
mat_X <- model.matrix(lm(formula = WWG ~ 0 + Sex, data = tbl_sire_model))
attr(mat_X, "assign") <- NULL
attr(mat_X, "contrasts") <- NULL
colnames(mat_X) <- NULL
cat(paste0(rmdhelp::bmatrix(pmat = mat_X, ps_name = "X", ps_env = "$$"), collapse = "\n"), "\n")
```

and

```{r, echo=FALSE, results='asis'}
mat_Z <- matrix(c(1, 0, 0,
                  0, 1, 0,
                  1, 0, 0,
                  0, 0, 1,
                  0, 1, 0), ncol = 3, byrow = TRUE)
cat(paste0(rmdhelp::bmatrix(pmat = mat_Z, ps_name = "Z", ps_env = "$$"), collapse = "\n"), "\n")
```

The matrix $A_s^{-1}$ can be obtained by calling the function `pedigreemm::getAinv()` on the defined sire pedigree.

```{r}
mat_Ainv <- pedigreemm::getAInv(ped = ped_sire)
```

That results in 

```{r, echo=FALSE, results='asis'}
mat_Ainv <- as.matrix(mat_Ainv)
cat(paste0(rmdhelp::bmatrix(pmat = mat_Ainv, ps_name = "A_s^{-1}", ps_env = "$$"), collapse = "\n"), "\n")
```

The vector $y$ corresponds to the vector of observations. With that we can solve the mixed model equations. 

```{r, echo=FALSE}
lambda <- sigma_e2 / sigma_s2
mat_xtx <- crossprod(mat_X)
mat_xtz <- crossprod(mat_X, mat_Z)
mat_ztx <- crossprod(mat_Z, mat_X)
mat_ztzainv <- crossprod(mat_Z) + lambda * mat_Ainv
mat_lhs <- rbind(cbind(mat_xtx,mat_xtz),cbind(mat_ztx,mat_ztzainv))
#rhs
vec_y <- tbl_sire_model$WWG
mat_xty <- crossprod(mat_X, vec_y)
mat_zty <- crossprod(mat_Z, vec_y)
mat_rhs <- rbind(mat_xty, mat_zty)
# sol
mat_sol <- solve(mat_lhs, mat_rhs)
vec_fix <- mat_sol[1:2,]
vec_rand <- mat_sol[3:(nrow(mat_sol)),]
```

For the fixed effects we get

```{r tbl-fix-eff-sol, echo=FALSE}
tbl_fix_eff_sol <- tibble::tibble(Sex = c("F","M"),
                                  Solution = vec_fix)
knitr::kable(tbl_fix_eff_sol,
             booktabs = TRUE,
             longtable = TRUE,
             caption = "Solutions for fixed Effect of Sex")
```

For the random sire breeding values, we get

```{r tbl-rand-eff-sol, echo=FALSE}
tbl_rand_eff_sol <- tibble::tibble(Sire = c(1,3,4),
                                   Solution = vec_rand)
knitr::kable(tbl_rand_eff_sol,
             booktabs = TRUE,
             longtable = TRUE,
             caption = "Solutions for random Breeding Values of Sires")

```

\pagebreak


### Animal Model
An extension of the sire model is called __animal model__. In an animal model not only the sires get predicted breeding values but all animals in the pedigree will be assigned a predicted breeding value. That is only possible, if we extend our dataset by the column of the dam of each animal for which we have observations. That leads to the following table.

```{r animalmodeldatamlem, echo=FALSE}
sigma_u2 <- 4 * sigma_s2
sigma_e2 <- sigma_p2 - sigma_u2
tbl_animal_model <- tibble::tibble(Animal = c(4:8),
                                 Sire   = c(1,3,1,4,3),
                                 Dam    = c(NA, 2, 2, 5, 6)
                                 Sex    = c("M","F","F","M","M"),
                                 WWG    = c(4.5, 2.9, 3.9, 3.5, 5.0))
knitr::kable(tbl_animal_model,
             booktabs = TRUE,
             longtable = TRUE,
             caption = "Pre-weaning Gain in kg for five beef animals")
```


## Genomic BLUP


## Other Resources
The following resources were used for this chapter:

* https://m-clark.github.io/mixed-models-with-R/
* https://www.r-bloggers.com/2017/12/linear-mixed-effect-models-in-r/
* https://gkhajduk.github.io/2017-03-09-mixed-models/
* One-factor anova: https://youtu.be/GctGncQrJew
* `r met$add("Brown2021a")`
* `r met$add("Singmann2019")`
* Repeated Measures ANOVA: 
    + https://conjugateprior.org/2013/01/formulae-in-r-anova/
    + https://s3-eu-west-1.amazonaws.com/s3-euw1-ap-pe-ws4-cws-documents.ri-prod/9781138024571/chapters/ch11/1_Least-Square_RM_ANOVA_in_R_Using_aov().JLH.pdf
* Data Anaylsis in R: https://bookdown.org/steve_midway/DAR/

