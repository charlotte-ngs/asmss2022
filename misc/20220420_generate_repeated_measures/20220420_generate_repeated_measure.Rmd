---
title: "Generate Repeated Measures Data"
output: html_notebook
---

# Disclaimer
Data with repeated measurements are described.


# Single Observation Data
The data with single observations for body weight and breast circumference from chapter 2 of the lecture notes are used as basis

```{r tab-reg-bw-bc, echo=FALSE, results='asis'}
tbl_reg <- tibble::tibble(Animal = c(1:10),
                          `Breast Circumference` = c(176, 177, 178, 179, 179, 180, 181, 182,183, 184),
                          `Body Weight` = c(471, 463, 481, 470, 496, 491, 518, 511, 510, 541))
n_nr_obs <- nrow(tbl_reg)
knitr::kable(tbl_reg,
             booktabs = TRUE,
             longtable = TRUE,
             caption = paste0("Breast Circumference and Body Weight for ", 
                              nrow(tbl_reg)," Animals", collapse = ""),
             escape = FALSE)
```


# Generate Multiple Observations per Animal

```{r, echo=FALSE}
n_nr_ani <- 4
n_nr_rep <- 3
n_sd_ratio <- 0.4
n_sd_bc <- sd(tbl_reg$`Breast Circumference`)
n_sd_bw <- sd(tbl_reg$`Body Weight`)
```

For course notes, we choose `r n_nr_ani` animals and generate `r n_nr_rep` repetitions from each observation. The variation within the observations of one animal is `r 100 * n_sd_ratio^2`% of the total phenotypic variation for body weight and breast circumference.

```{r}
set.seed(432)
vec_sel_ani <- sample(tbl_reg$Animal, size = n_nr_ani)
# loop over selected animals
tbl_rep_obs <- NULL
for (aidx in vec_sel_ani){
  # add observation of currently selected animal aidx
  if (is.null(tbl_rep_obs)){
    tbl_rep_obs <- tbl_reg[aidx,]
  } else {
    tbl_rep_obs <- dplyr::bind_rows(tbl_rep_obs, tbl_reg[aidx,])
  }
  # add repeated observations
  tbl_rep_cur <- tibble::tibble(Animal = rep(aidx, n_nr_rep-1),
                                `Breast Circumference` = rnorm((n_nr_rep-1), 
                                                               mean = tbl_reg$`Breast Circumference`[aidx],
                                                               sd = n_sd_bc*n_sd_ratio),
                                `Body Weight` = rnorm((n_nr_rep-1),
                                                      mean = tbl_reg$`Body Weight`[aidx],
                                                      sd = n_sd_bw*n_sd_ratio))
  tbl_rep_obs <- dplyr::bind_rows(tbl_rep_obs, tbl_rep_cur)
  
}
tbl_rep_obs
```

# File
The generated data is written to a file.

```{r}
s_rep_obs_path <- file.path(here::here(), "docs", "data", "asm_bw_bc_rep_obs.csv")
if (!file.exists(s_rep_obs_path)) readr::write_csv(tbl_rep_obs, file = s_rep_obs_path)
```



# Plot

```{r}
tbl_rep_obs$Animal <- as.factor(tbl_rep_obs$Animal)
ggplot2::ggplot(data = tbl_rep_obs, mapping = ggplot2::aes(x = `Breast Circumference`, 
                                                           y = `Body Weight`, 
                                                           color = Animal)) + 
  ggplot2::geom_point()
```

# Analysis
The repeated observation data can still be analysed with a linear regression model

```{r}
lm_rep_obs <- lm(`Body Weight` ~ `Breast Circumference`, data = tbl_rep_obs)
summary(lm_rep_obs)
```

But the assumptions of independent observations is violated. This can be seen in the residuals plot.

```{r}
tbl_rep_obs$Animal <- as.factor(tbl_rep_obs$Animal)
ggplot2::ggplot(data = tibble::tibble(Animal = tbl_rep_obs$Animal, 
                                      Fitted = fitted(lm_rep_obs), 
                                      Residuals = residuals(lm_rep_obs)),
                ggplot2::aes(x = Fitted, y = Residuals, color = Animal)) + 
  ggplot2::geom_point()
```

```{r}
plot(lm_rep_obs)
```

